# 概述

DA145x软件平台利用了由Riviera Waves许可的小型高效实时内核。 内核提供以下功能：

1. 任务创建和状态转换。
2. 任务之间的消息交换。
3. 计时器管理。
4. 动态内存分配。
5. BLE事件的调度和处理



# 消息调度机制

## 申请消息

函数通过ke_msg_alloc申请消息，入参分别为消息ID，目的task_id， 源task_id以及消息参数的长度。

```
void *__fastcall ke_msg_alloc(const ke_msg_id_t id, const ke_task_id_t dest_id, const ke_task_id_t src_id, const uint16_t param_len)
{
  size_t v6; // r4
  ke_msg *msg; // r0
  uint32_t *v9; // r5

  v6 = param_len;
  msg = ke_malloc(param_len + 16, 2);  // 申请内存
  msg->hdr.next = -1;
  msg->saved = 0;
  msg->id = id;
  msg->dest_id = dest_id;
  msg->src_id = src_id;
  msg->param_len = v6;
  v9 = msg->param;
  memset(msg->param, 0, v6);
  return v9;
}
```

返回值是一个ke_msg结构体的param部分

```
struct ke_msg
{
  struct co_list_hdr hdr;
  uint32_t saved;
  ke_msg_id_t id;
  ke_task_id_t dest_id;
  ke_task_id_t src_id;
  uint16_t param_len;  // param 的长度
  uint32_t param[1];
};
```

## 消息释放

ke_msg_free直接使用 ke_free 释放内存。

```
int __fastcall ke_msg_free(int a1)
{
  return ke_free(a1);
}
```

ke_msg_free的入参是 `ke_msg*`，但是`ke_msg_alloc`返回是`ke_msg`的`param`，所以在使用`ke_msg_free`很有可能出现指针没有减`0x10（ke_msg头部的大小）`的情况。

